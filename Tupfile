CFLAGS += @(LUA_CFLAGS)
LFLAGS += @(LUA_LFLAGS)

CFLAGS += -I@(NATIVE_CLIENT_PATH)
LFLAGS += -L@(NATIVE_CLIENT_PATH)

ifeq (@(TUP_PLATFORM),win32)
  LFLAGS += -llibdeepspeech.so.if
  EXT = dll
  OTHERS = lua-deepspeech.lib lua-deepspeech.exp
else
  # The 'undefined dynamic_lookup' stuff lets us link against Lua and DeepSpeech at runtime, so make
  # sure your executable includes Lua and is otherwise able to find the DeepSpeech shared library.
  # On windows, you just need to put the dlls next to the executable
  LFLAGS += -undefined dynamic_lookup -ldeepspeech
  EXT = so
endif

!compile = |> ^ CC %f^ clang $(CFLAGS) -c %f -o %o |>
!link = |> ^ LN %o^ clang -shared -o %o $(LFLAGS) %f |>

: lua_deepspeech.c |> !compile |> lua_deepspeech.o
: lua_deepspeech.o |> !link |> lua-deepspeech.$(EXT) | $(OTHERS)
